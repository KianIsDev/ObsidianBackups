#!/bin/bash

echo ""
echo "---------------------"
echo "WELCOME TO THE OBSIDIAN BACKUP TOOL!"
echo "---------------------"
echo ""

if [[ ! -f obsidian.path ]];
then
    echo "" > obsidian.path
fi


obsidianRunCommand=$(cat obsidian.path);

ableToOpenExternalTerminal="1";

if x-terminal-emulator -e "bash -c 'echo \"...\"'"
then
    ableToOpenExternalTerminal="1"
    echo "External terminals supported!"
else
    echo "Limited terminal functionality detected."
    ableToOpenExternalTerminal="0"
fi


promptLocateObsidian="echo -e \"\e[31mNo Obsidian Command Specified!\e[0m \"; echo \"\"; echo -e \"(\e[32mOn Linux\e[0m) Right-click the Obsidian icon in the super-key menue > Properties > Copy the \\\"\e[94mCommand\e[0m\\\" field.\"; echo \"\"; echo -e \"(\e[32mOn A Windows Virtual Machine\e[0m) Search up \\\"Obsidian\\\" in the windows menu > \\\"Open file location\\\" x2\"; echo \"The path should be something like: \\\"C:/Users/Name/AppData/Local/Programs/Obsidian/Obsidian.exe\\\"\"; echo \"Now replace \\\"C:\\\" with \\\"cmd.exe mnt/c\\\"\"; echo -e \"Example: \\\"\e[94mcmd.exe mnt/c/Users/Name/AppData/Local/Programs/Obsidian/Obsidian.exe\e[0m\\\" (You should be able to run this command straight in a terminal! )\"; echo\"\"; echo -e \"(\e[33mHint\e[0m) If you dont want this tool to automatically boot up obsidian when it starts, simply write \\\"\e[94m0\e[0m\\\" \"; echo\"\";";

uploadToGit() {
    echo ""
    echo "Backing up obsidian at: ${PWD}"

    echo "(ADD)"

	git add .
    
    echo "(COMMIT)"

	dateString=$(date '+%d/%m/%Y %H:%M:%S');
	git commit -a -m "Backup $dateString"

    echo "(PULL)"

    git pull

    echo "(PUSH)"

	git push
	echo "Backup $dateString" >> BackupLog.running
}


if [[ $obsidianRunCommand == "" ]];
then
    
    echo "opening new terminal"

    if [[ $ableToOpenExternalTerminal == "1" ]];
    then
        x-terminal-emulator -e "bash -c '${promptLocateObsidian} read -p \"What is the executable command? \" ORC; echo \$ORC > obsidian.path;'";
        # The popup window succesfully showed up!
        echo "popup terminal succesfully closed!"
        
    else
        # No support for opening new terminals
        echo -e "\e[33mUnable to open new terminal\e[0m... Continuing in this terminal"
        echo ""
        echo "---------------------"
        bash -c "${promptLocateObsidian}";
        echo "---------------------"

        read -p "What is the executable command? " ORC;
        echo $ORC > obsidian.path;
    fi
    
    echo ""


    while [[ $obsidianRunCommand == "" ]]
    do
        echo "reading user input..."
        sleep 1
        obsidianRunCommand=$(cat obsidian.path)
    done
fi

echo "";
echo "Obsidian command: $obsidianRunCommand";
echo "";

currentId=$(date '+%d');
echo "${currentId}" > running.running;

bootObsidianCommand="echo \"$currentId\" > running.running; $obsidianRunCommand; echo \"-1\" > running.running;";


if [[ $obsidianRunCommand == "0" ]];
then
    echo "You are now in independant upload mode. This tool will still upload changes to github in the background, but it wont stop again, when obsidian is closed";
    echo "";
    sleep 2;
    
    uploadToGit;

    closeMe="0";
    while [[ $closeMe != "1" ]]
    do
        echo "Write \"1\" when you no longer need to back up your obsidian files:"
        read -t 30 closeMe;
        echo "";
        echo -e "\e[32mUploading to github\e[0m next upload in 30 seconds...";
        uploadToGit;
        echo "";
    done
    runningId="-1";

else
    if [[ $ableToOpenExternalTerminal == "1" ]];
    then
        x-terminal-emulator -e "bash -c '${bootObsidianCommand}'" &
        echo ""
        echo "popup terminal opened succesfully!"
        
        runningId=$(cat running.running)
        while [[ $runningId == $currentId ]]
        do
            uploadToGit;
	        runningId=$(cat running.running)
            currentId=$(date '+%d');
	        echo -e "\e[32mRunning SessionID\e[0m[$runningId] \e[32mExpected SessionID\e[0m[$currentId]"

            if [[ $runningId -ne "-1" ]];
            then
                printf "Next backup in: 25 "

            	sleep 15
                printf "10 "
                sleep 5
                printf "5 "
                sleep 1
                printf "4 "
                sleep 1
                printf "3 "
                sleep 1
                printf "2 "
                sleep 1
                echo "1"
                sleep 1
            fi
            
        done

    else
        uploadToGit;
        echo "";
        echo "---------------------"
        echo -e "\e[33mUnable to open new terminal\e[0m... Obsidian will therefor be running from this terminal. Unfortunately that means no dynamic uploading. All changes will be uploadet once obsidian has closed."
        echo ""
        echo -e "\e[31mREMEMBER TO CLOSE OBSIDIAN BEFORE TURNNG OFF THE PC!!!\e[0m"
        echo "---------------------"
        
        sleep 2;        

        bash -c "${bootObsidianCommand}";
        uploadToGit;
        runningId="-1";
        echo ""
    fi
fi


if [[ $runningId != "-1" ]]; then
    if [[ $ableToOpenExternalTerminal == "1" ]];
    then
        x-terminal-emulator -e "bash -c 'echo -e \"\e[31mDAILY SESSION EXPIRED!\e[0m Close Obsidian and re-open the backup program to start a new session\"; exec bash'" &
    else
        echo ""
        echo "---------------------"
        echo -e "\e[31mDAILY SESSION EXPIRED!\e[0m Close Obsidian and re-open the backup program to start a new session";

    fi

else
    if [[ $ableToOpenExternalTerminal == "1" ]];
    then
        x-terminal-emulator -e "bash -c 'echo -e \"\e[32mClosing Backup-Tool\e[0m dont wait for this window to close... Just close it already! \"; read -t 5;'" &
    else
        echo -e "\e[32mClosing Backup-Tool\e[0m"
    fi
fi

read -p "Press [enter] to close..."

echo "-1" > running.running

