#!/bin/bash

# gnome-terminal
# /usr/bin/flatpak run --branch=stable --arch=x86_64 --command=obsidian.sh --file-forwarding md.obsidian.Obsidian @@u %U @@
# /usr/bin/flatpak run --branch=stable --arch=x86_64 --command=obsidian.sh --file-forwarding md.obsidian.Obsidian @@u %U @@
# /usr/bin/flatpak run md.obsidian.Obsidian
echo "" >> obsidian.path

obsidianRunCommand=$(cat obsidian.path);


if [[ $obsidianRunCommand == "" ]];
then
    gnome-terminal -- bash -c "echo -e \"\e[31mNo Obsidian path!\e[0m paste the executable path.\";	echo \"(On Linux) Right-click the Obsidian icon in the super-key menue > Properties > Copy the \\\"Command\\\" field.\"; read -p \"What is the executable command? \" ORC; echo \$ORC > obsidian.path;";

    while [$obsidianRunCommand -eq ""]
    do
        echo "waiting for user to paste the executable path..."
        sleep 10
        obsidianRunCommand=$(cat obsidian.path)
    done
fi

echo "Opening $obsidianRunCommand";

currentId=$(date '+%d');
gnome-terminal -- bash -c "echo \"$currentId\" > running.running; $obsidianRunCommand; echo \"-1\" > running.running"

runningId=$(cat running.running)
while [ $runningId -eq $currentId ]
do
    echo "Backing up obsidian at: ${PWD}"
	git add .
    
    currentId=$(date '+%d');
	dateString=$(date '+%d/%m/%Y %H:%M:%S');
	git commit -a -m "Backup $dateString"

    git pull

	git push
	echo "Backup $dateString" >> BackupLog.running
	runningId=$(cat running.running)
	echo -e "\e[32mRunning SessionID\e[0m[$runningId] \e[32mExpected SessionID\e[0m[$currentId]"
	sleep 20

    echo "3"
    sleep 1
    printf "2"
    sleep 1
    printf "1"
    sleep 1
    
done



if [[ $runningId -ne "-1" ]]; then
	gnome-terminal -- bash -c "echo -e \"\e[31mDAILY SESSION EXPIRED!\e[0m Close Obsidian and re-open the backup program to start a new session\"; exec bash"
else
	gnome-terminal -- bash -c "echo -e \"\e[32mClosing Backup-Tool\e[0m dont wait for this window to close... Just close it already! \"; sleep 5;"
fi

read -p "Press [enter] to close..."

echo "-1" > running.running
