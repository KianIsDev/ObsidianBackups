#!/bin/bash

# gnome-terminal
# /usr/bin/flatpak run --branch=stable --arch=x86_64 --command=obsidian.sh --file-forwarding md.obsidian.Obsidian @@u %U @@
# /usr/bin/flatpak run --branch=stable --arch=x86_64 --command=obsidian.sh --file-forwarding md.obsidian.Obsidian @@u %U @@
# /usr/bin/flatpak run md.obsidian.Obsidian
echo "" >> obsidian.path

obsidianRunCommand=$(cat obsidian.path);

ableToOpenExternalTerminal="1";

promptLocateObsidian="echo -e \"\e[31mNo Obsidian Command Specified!\e[0m \"; echo \"\"; echo -e \"(\e[32mOn Linux\e[0m) Right-click the Obsidian icon in the super-key menue > Properties > Copy the \\\"Command\\\" field.\"; echo\"\";  echo -e \"(\e[33mOn A Virtual Machine\e[0m) Or if you dont want this tool to automatically boot up obsidian when it starts, simply write \\\"0\\\" \"; echo\"\";";

if [[ $obsidianRunCommand == "" ]];
then
    
    echo "opening new terminal"

    if x-terminal-emulator -e "bash -c '${promptLocateObsidian} read -p \"What is the executable command? \" ORC; echo \$ORC > obsidian.path;'"
    then
        # The popup window succesfully showed up!
        echo "popup terminal succesfully closed!"

    else
        # No support for opening new terminals
        echo -e "\e[33mUnable to open new terminal\e[0m... Continuing in this terminal"
        ableToOpenExternalTerminal="0";
    fi
    

    if [[ $ableToOpenExternalTerminal -ne "1" ]];
    then
        echo ""
        echo "---------------------"
        bash -c "${promptLocateObsidian}";
        echo "---------------------"

        read -p "What is the executable command? " ORC;
        echo $ORC > obsidian.path;
    fi


    while [[ $obsidianRunCommand == "" ]]
    do
        echo "reading user input..."
        sleep 1
        obsidianRunCommand=$(cat obsidian.path)
    done
fi

echo "";
echo "Opening $obsidianRunCommand";
echo "";

currentId=$(date '+%d');
echo "${currentId}" > running.running;

bootObsidianCommand="echo \"$currentId\" > running.running; $obsidianRunCommand; echo \"-1\" > running.running";

if x-terminal-emulator -e "bash -c '${bootObsidianCommand}'" &
then
    echo "popup terminal succesfully closed!"
else
    echo -e "\e[33mUnable to open new terminal\e[0m... Obsidian will therefor be running from this terminal. Unfortunately that means no dynamic uploading. All changes will be uploadet once obsidian has closed."
    echo -e "\e[31mREMEMBER TO CLOSE OBSIDIAN BEFORE TURNNG OFF THE PC!!!"
    bash -c "${bootObsidianCommand}";
fi

runningId=$(cat running.running)
while [[ $runningId == $currentId ]]
do
    echo "Backing up obsidian at: ${PWD}"

    echo "(ADD)"

	git add .
    
    echo "(COMMIT)"

    currentId=$(date '+%d');
	dateString=$(date '+%d/%m/%Y %H:%M:%S');
	git commit -a -m "Backup $dateString"

    echo "(PULL)"

    git pull

    echo "(PUSH)"

	git push
	echo "Backup $dateString" >> BackupLog.running
	runningId=$(cat running.running)
	echo -e "\e[32mRunning SessionID\e[0m[$runningId] \e[32mExpected SessionID\e[0m[$currentId]"

    if [[ $runningId -ne "-1" ]];
    then
    	sleep 20
    fi

    printf "3 "
    sleep 1
    printf "2 "
    sleep 1
    echo "1"
    sleep 1
    
done



if [[ $runningId != "-1" ]]; then
	gnome-terminal -- bash -c "echo -e \"\e[31mDAILY SESSION EXPIRED!\e[0m Close Obsidian and re-open the backup program to start a new session\"; exec bash"
else
	gnome-terminal -- bash -c "echo -e \"\e[32mClosing Backup-Tool\e[0m dont wait for this window to close... Just close it already! \"; sleep 5;"
fi

read -p "Press [enter] to close..."

echo "-1" > running.running
